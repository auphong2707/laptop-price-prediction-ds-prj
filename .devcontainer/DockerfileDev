# Base image
FROM python:3.11.9-slim

# Set the working directory in the container
WORKDIR /app

# Set environment variables
ENV AIRFLOW_HOME=/app/airflow

# [PYTHON]
# Copy requirements and install dependencies
COPY requirements.txt .

# Install Airflow
RUN pip install --no-cache-dir apache-airflow==2.10.2 --constraint "https://raw.githubusercontent.com/apache/airflow/constraints-2.10.2/constraints-3.11.txt"

# Install Python packages from requirements.txt
RUN pip install --no-cache-dir -r requirements.txt


# [APT]
# Update package list and install required packages
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    wget \
    firefox-esr \
    postgresql \
    postgresql-contrib \
    wkhtmltopdf \
    sudo \
    && rm -rf /var/lib/apt/lists/*

# Install Geckodriver
RUN wget "https://github.com/mozilla/geckodriver/releases/download/v0.35.0/geckodriver-v0.35.0-linux64.tar.gz" -O /tmp/geckodriver.tar.gz \
    && tar -xvzf /tmp/geckodriver.tar.gz -C /tmp/ \
    && mv /tmp/geckodriver /usr/local/bin/ \
    && chmod +x /usr/local/bin/geckodriver \
    && rm /tmp/geckodriver.tar.gz

# Set up PostgreSQL database and user
USER postgres

# Start PostgreSQL, create database and user, then stop PostgreSQL
RUN service postgresql start && \
    psql -c "CREATE USER airflow PASSWORD 'airflow';" && \
    psql -c "CREATE DATABASE airflow;" && \
    psql -c "GRANT ALL PRIVILEGES ON DATABASE airflow TO airflow;" && \
    psql -d airflow -c "GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO airflow;" && \
    psql -d airflow -c "GRANT USAGE ON SCHEMA public TO airflow;" && \
    psql -d airflow -c "GRANT USAGE ON ALL SEQUENCES IN SCHEMA public TO airflow;" && \
    psql -c "ALTER DATABASE airflow OWNER TO airflow;" && \
    service postgresql stop

# Switch back to root user
USER root

# Expose ports for PostgreSQL and Airflow
EXPOSE 5432 8080

# Entrypoint script to start PostgreSQL and Airflow webserver & scheduler
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

ENTRYPOINT ["/entrypoint.sh"]